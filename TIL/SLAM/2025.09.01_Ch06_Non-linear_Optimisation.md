# Chapter 06: 비선형 최적화
## 01. 배치 상태 추정 및 최대 사후 추정
이산 시간 모션 방정식과 관찰 방정식은 아래와 같다.

```math
\begin{cases}
x_k = f(x_{k-1}, u_k) + w_k \\
z_{k, j} = h(y_j, x_k) + v_{k, j}
\end{cases}
```

$x_k$는 $SE(3)$로 설명할 수 있는 카메라 포즈 인 것을 4장에서 알게 되었다. 관찰 방정식에 관해서는 핀홀 카메라 모델이라는 것을 5장에서 분명히 했다. 포즈 변수 $x_k$ 는 $T_k \in SE(3)$으로 표현할 수 있다. 모션 방정식은 입력의 특정 형태와 관련이 있지만 Visual SLAM에는 특수성이 없다. 관찰 방정식은 핀홀 모델에 의해 지정된다. $x_k$ 에서 이미지의 픽셀 위치 $z_{k, j}$ 에 해당하는 랜드마크 $y_j$ 를 관찰한다고 가정하면 아래의 관찰 방정식을 나타낼 수 있다.

```math
sz_{k, j} = K(R_k y_j + t_k)
```

$K$ 는 내부 파라미터이고, $s$는 픽셀 거리이며, $R_k$ 는 회전 행렬, $t_k$는 병진 벡터, $y_j$는 랜드마크의 위치이다. $R_k$ 는 회전 행렬과 $t_k$ 는 병진 벡터는 병령 행렬 $T_k$ 를 사용하여 표현할 수 있으며, 이 경우 랜드마크 위치 $y_j$ 도 동차 좌표로 표현되어야 하며, 계산이 완료된 후 비동차좌표로 변환해야 한다.

노이즈의 영향을 받으면 데이터가 어떻게 변경되는지 보자. 모션 및 관찰 방정식에서 일반적으로 아래와 같이 두 개의 노이즈 항 $w_k, v_k$ 가 평균이 0인 가우시안 분포를 충족한다고 가정한다.

```math
w_k \sim \mathcal{N}(0, R_k), v_k \sim \mathcal{N}(0, Q_{k, j})
```

$\mathcal{N}$ 는 가우스 분포를 나타내며, 0은 평균이 0임을 나타내고, $R_k, Q_{k, j}$ 는 공분산 행렬을 나타낸다. 이러한 노이즈의 영향으로 노이즈가 있는 데이터 $z$ 및 $u$ 를 통해 포즈 $x$ 및 랜드마크 위치 $y$ 를 추론하려고 하며, 이는 상태 추정 문제를 구성한다.

상태 추정 문제를 처리하는 방법은 크게 두가지로 나뉜다.

1. 증분/점진적 방법 또는 필터링이라고 한다. SLAM 프로세스 중에 시간이 지남에 따라 데이터가 점진적으로 제공되기 때문에 현재 시간에 대한 추정 상태를 유지한 다음 새 데이터로 업데이트해야 한다. 오랜 시간 동안 연구자들은 필터를 사용하여 특히, 확장 칼만 필터와 그것으로부터 파생된 방법들을 통해 해결했다.

2. 배치 추정 방법이다. 데이터를 한 파일에 함께 저장하고, 항상 최고의 경로와 지도를 찾는 방법이다. 즉, 0에서 $k$ 순간까지의 모든 입력 및 관찰 데이터를 함께 수집하고 이를 통해 0에서 $k$ 순간 까지의 궤적과 맵을 추정하는 방법을 생각해 볼 수 있다.

이 두가지 접근 방식은 많은 다른 추정을 유도한다. 일반적으로 증분 방법은 현재 순간의 상태 추정 $x_k$ 에만 관심이 있고, 이전 상태는 거의 고려되지 않는다. 대조적으로 배치 방법은 더 넓은 범위에서 최적화될 수 있고, 기존의 필터링 방법보다 더 나은 것으로 간주돠며, 현재 Visual SLAM의 주류 방법이 된다.

SLAM에서 실용적인 접근 방식은 종종 몇 가지 절충안인 경우가 있다. 예를 들어 일부 과거 궤적을 수정하고 현재 순간에 가까운 일부 궤적만 최적화하는 것으로 윈도우 추정 방법이 있다.

이론적으로는 배치 처리 방법이 더 쉽게 다가올 수 있다. 배치 처리 방법을 이해하면 증분 처리 방법을 더 쉽게 이해할 수도 있다. 배치 처리 방법에 관해 설명하므로, 1에서 N까지의 모든 순간을 고려하고 M개의 랜드마크가 있다고 가정한다. 모든 순간에 로봇 포즈 및 랜드마크 좌표는 아래와 같이 정의한다.

```math
x = \{x_1, ... , x_N\}, \ y = \{y_1, ..., y_M\}
```

모든 순간에 대한 입력은 $u$ 로 표시되고, $z$ 는 모든 순간에 대한 관찰을 나타낸다. 따라서 확률의 관점에서 로봇 상태의 추정은 입력 데이터 $u$ 와 관측 데이터 $z$ 의 조건에서 상태 $x, y$ 의 조건부 확률 분포를 찾는 것이다.

```math
P(x, y | z, u)
```

특히, 제어 입력을 모르고 오직 하나의 이미지를 가지고 관찰 방정식에 의해 초래된 데이터만 고려하는 경우, $P(x, y|z)$ 의 조건부 확률 분포를 추정하는 것과 동일하다. 이러한 문제를 SfM 이라고 하며, 이는 많은 이미지로부터 3차원 공간 구조를 재구성하는 방법이다.

상태 변수의 조건부 확률 분포를 추정하기 위해 아래와 같은 베이즈 방정식이 사용된다.