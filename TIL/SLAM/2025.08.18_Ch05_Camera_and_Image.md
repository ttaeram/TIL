# Chapter 05: 카메라 및 이미지
## 01. 핀홀 카메라 모델
카메라가 3D 세계의 좌표 점을 2D 이미지 평면에 매핑하는 프로세스는 기하학적 모데레로 설명 가능하다. 이 모델이는 여러 가지가 있지만 그 중 가장 간단한 모델은 핀홀 모델이다. 핀홀 모델은 핀홀을 통과한 후 핀홀 뒷면에 투영된 광선의 이미징 관계를 설명하는 일반적이로 효과적인 모델이다. 카메라 렌즈의 존재로 인해 빛이 이미징 평면에 투사되는 과정에서 왜곡이 발생한다. 따라서 핀홀과 왜곡 모델을 통해 전체 투영 프로세스를 설명한다. 두 모델은 외부 3D 점을 카메라의 내부 이미징 평면에 투영하여 카메라의 내부 매개변수를 형성한다.

### 1-1. 핀홀 카메라 모델
어두운 상자 앞에 촛불을 두면 촛불은 어두운 상자의 작은 구멍을 통해 후면의 평면으로 투영된다. 이 때 평면에 촛불 이미지가 거꾸로 형성되게 된다. 이 과정에서 작은 구멍 모델은 3D 새계에서 2D 이미징 평면에 투영한다고 할 수 있다.

간단한 핀홀 모델을 기하학적으로 모델링해본다. $O-x-y-z$를 카메라 좌표계로 설정하면, $z$ 축이 카메라 앞을 가리키고, $x$ 축이 오른쪽으로, $y$ 축이 아래쪽을 향하도록 하는 것이 좋다. $O$ 는 카메라의 광 중심이며 핀홀 모델의 핀홀이기도 하다. 구멍 $O$ 에 투영된 후, 3D 포인트 $P$ 는 물리적 이미징 평면 $O'-x'-y'$ 에 떨어지며 이미지 포인트 $P'$ 를 생성한다. $P$ 의 좌표는 $[X, Y, Z]^T$ 이고, $P'$ 의 좌표는 $[X', Y', Z']^T$ 이며, 물리적 이미징 평면에서 작은 구멍이 있는 카메라 평면까지의 거리는 $f$ 이다. 따라서 삼각형 유사 관계에 따라 아래의 방정식이 나온다.

```math
\frac{Z}{f} = -\frac{X}{X'} = -\frac{Y}{Y'}
```

음수($-$) 기호는 반전된 이미지임을 나타낸다. 하지만 카메라로 사진을 찍을 때 사진이 반전되어 있지 않다. 모델을 보다 현실적으로 만들기 위해 3차원 공간 점과 함께 카메라 좌표계의 동일한 측면에 이미징 평면을 카메라 앞에 대칭으로 배치할 수 있다. 이 방법으로 수식에서도 음수를 제거하여 더 간결한 표현이 가능하다.

```math
\frac{Z}{f} = \frac{X}{X'} = \frac{Y}{Y'}
```

```math
X' = f\frac{X}{Z} \\
Y' = f\frac{Y}{Z}
```

이미징 평면을 임의로 앞쪽으로 옮기는 것은 카메라 투영을 처리하기 위한 수학적 접근일 뿐이고, 카메라가 캡쳐한 대부분의 이미지는 반전되는 것이 아니다. 카메라 자체의 소프트웨어가 사진을 뒤집기 때문에 실제로 얻는 것은 대칭 평면의 이미지이다.

위의 식은 초점 거리 $f$ 가 0.2m 이고, $X'$ 가 0.14m 인 경우와 같이, 모든 점의 단위가 미터로 이해될 수 있는 점 $P$ 와 이미지 간의 공간 관계를 설명한다. 하지만 카메라에서 얻는 것은 이미징 평면에서 이미지를 샘플링하고 정량화해야 하는 픽셀이다. 센서가 느끼는 빛은 이미지 픽셀로 변환하는 프로세스를 설명하기 위해 물리적 이미징 평면에 픽셀 평면 $o-u-v$ 를 고정하면, 픽셀 평면에서 $P'$ 의 픽셀 좌표인 $[u, v]^T$ 를 얻을 수 있다. 

픽셀 좌표계는 일반적으로 이미지의 왼쪽 위 모서리에 있는 원점 $o'$ , $x$ 축과 오른쪽으로 평행한 $u$ 축, $v$ 축은 $y$ 축과 평행하게 아래쪽으로 정의된다. 픽셀 좌표계와 이미징 평면 사이에는 배율 조정과 원점의 변환이 있다. $u$ 축에서 $\alpha$ 배 배율을 조정하고 $v$ 축에서 $\beta$ 배 배율을 조정하도록 픽셀 좌표를 설정한다. 동시에 원점이 $[c_x, c_y]^T$ 로 이동한다. 따라서 $P'$ 의 좌표와 픽셀 좌표 $[u, v]^T$ 의 관계는 아래와 같다.

```math
\begin{cases} u = \alpha X' + c_x \\
v = \beta Y' + c_y \end{cases}
```

$X'$ 과 $Y'$에 앞서 구한 수식을 대입하고, $\alpha f$ 를 $f_x$ 로, $\beta f$ 를 $f_y$ 로 치환하면 아래와 같다.

```math
\begin{cases} u = f_x \frac{X}{Z} + c_x \\
v = f_y \frac{Y}{Z} + c_y \end{cases}
```

여기서 $f$ 의 단위는 미터이고, $\alpha, \beta$ 의 단위는 픽셀/미터 이므로, $f_x, f_y$ 와 $c_x, c_y$ 의 단위는 픽셀이다. 행렬로 작성하는 것이 더 간결하지만, 왼쪽에는 동차 좌표계가 필요하고, 오른쪽은 비동차 좌표계가 필요하다.

```math
\begin{bmatrix}u \\ v \\ 1 \end{bmatrix}
= \frac{1}{Z} \begin{bmatrix} f_x & 0 & c_x \\ 0 & f_y & c_y \\ 0 & 0 & 1 \end{bmatrix} \begin{bmatrix} X \\ Y \\ Z \end{bmatrix}
\overset{\underset{\mathrm{def}}{}}{=} \frac{1}{Z}KP \\
Z\begin{bmatrix}u \\ v \\ 1 \end{bmatrix}
= \begin{bmatrix} f_x & 0 & c_x \\ 0 & f_y & c_y \\ 0 & 0 & 1 \end{bmatrix} \begin{bmatrix} X \\ Y \\ Z \end{bmatrix}
\overset{\underset{\mathrm{def}}{}}{=} KP
```

위 식의 중간에 있는 행렬을 카메라의 내부 파라미터 행렬 $K$ 라고 한다. 일반적인 카메라의 내부 파라미터는 고정되어 있으며, 사용 중에는 변경되지 않는다고 간주된다. 일부 카메라 제조업체는 카메라의 내부 매개변수에 대해 알려주며, 때로는 보정이라고 하는 과정을 통해 카메라의 내부 파라미터를 직접 구한다.

외부 파라미터도 존재한다. 위 식에서는 카메라 좌표계에서 $P$ 의 좌표를 사용하지만, 실제로는 카메라가 이동 중이므로, $P$ 의 카메라 좌표는 카메라의 현재 자세에 따라 카메라 좌표계 아래로 변환된 결과여야 한다. 카메라의 자세는 회전 매트릭스 $R$ 과 변환 벡터 $t$ 로 설명된다. 그래서 아래 방정식이 있다.

```math
ZP_{uv} = Z\begin{bmatrix} u \\ v \\ 1 \end{bmatrix}
= K(RP_W + t) = KTP_W
```

$KTP_W$ 는 동차 좌표계에서 비동차 좌표계로의 변환을 암시한다. 이것은 $P$ 의 표준 좌표계에서 픽셀 좌표계로의 투영 관계를 설명한다. 카메라 포즈 $R, t$ 는 카메라의 외부 파라미터라고 한다. 이는 카메라의 설치 상태에 따라 변경될 수 있고, SLAM의 추정 대상이 된다.

투영 프로세스는 다른 관점에서도 볼 수 있다. 위 식은 표준 좌표점을 카메라 좌표계로 변환한 다음, 마지막 차원의 값을 제거할 수 있음을 보여준다.

```math
(RP_W + t) = \underbrace{[X, Y, Z]^T}_{카메라\ 좌표} \to \underbrace{[X/Z, Y/Z, 1]^T}_{정규화\ 좌표}
```

정규화 좌표는 $z=1$ 평면의 점으로 볼 수 있고, 이 평면을 정규화 평면이라고 한다. 정규화된 좌표와 왼쪽 곱셈의 내부 파라미터는 픽셀 좌표를 가지므로, 픽셀 좌표 $[u, v]^T$ 를 정규화된 평면의 점 쌍으로 정량적 측정이 가능하다. 이 모델에서 볼 수 있듯이 카메라 좌표에 0이 아닌 상수를 동시에 곱하면 정규화된 좌표가 동일하며, 이는 투영 중에 점의 깊이가 손실되기 때문에 단안 비전에서 픽셀의 값을 얻을 수 없음을 보인다.

### 1-2. 왜곡 모델
더 넓은 화각의 이미징을 얻기 위해 카메라 앞에 렌즈를 추가할 수 있다. 렌즈의 추가는 이미징 과정에서 빛의 전파에 새로운 영향을 미친다.

1. 렌즈 자체의 모양이 빛의 전파에 미치는 영향

2. 기계적 조립 과정에서 렌즈와 이미징 평면이 완전히 평행할 수 없으므로, 렌즈를 통해 렌즈가 이미징 형면에 투영될 때 빛의 위치가 변경된다.

렌즈 형상에 의한 왜곡을 방사형 왜곡이라고 한다. 핀홀 모델에서 선은 픽셀 평면에 투영되거나 직선이다. 하지만 실제 촬영된 사진에서 카메라의 렌즈는 실제 환경에서 직선을 곡선으로 만드는 경향이 있다. 이미지의 가장자리에 가까울수로 이 현상이 두드러진다.

![lens distortion](./assets/Ch05/lens_distortion.png)

> 방사형 왜곡의 두가지 유형: 배럴 왜곡, 쿠션 왜곡

렌즈는 보통 중심 대칭이기 때문에, 왜곡은 일반적으로 방사형 대칭이다. 이는 위 그림과 같이 배럴 왜곡과 쿠션 왜곡 두 가지로 보통 나뉜다.

배럴 왜곡은 광축으로부터의 거리가 증가함에 따라 픽셀 반경이 감소하지만, 쿠션 왜곡은 픽셀 반경이 증가한다. 두 왜곡 모두 이미지의 중심과 광축의 교차점을 통과하는 직선은 형태를 그대로 유지한다.

렌즈의 형상은 방사형 왜곡을 일으킬 수 있을 뿐 아니라 렌즈와 이미징 표면이 카메라 조립 중 완벽한 평행이 될 수 없으므로 접선 왜곡도 나타난다.

방사형 왜곡과 접선 왜곡을 이해하기 위해 수학적 형태로 설명해보자. 좌표가 $[x, y]^T$ 인 정규화 평면에 임의의 점 $p$ 를 고려하거나 극좌표의 형태인 $[r, \theta]^T$ 로 작성할 수 있다. $r$ 은 점 $p$ 와 좌표계 원점 사이의 거리를 나타내고, $\theta$ 는 수평축과의 각도를 나타낸다. 방사형 왜곡은 좌표점이 길이 방향에 따라 변경되는 것을 볼 수 있다. 접선 왜곡은 좌표점이 접선 방향에 따라 변경되는 것을 볼 수 있다. 일반적으로 이러한 왜곡은 다항식 관계로 가정된다.

```math
x_{distorted} = x(1 + k_1r^2 + k_2r^4 + k_3r^6) \\
y_{distorted} = y(1 + k_1r^2 + k_2r^4 + k_3r^6)
```

$[x_{distorted}, y_{distorted}]^T$ 는 왜곡 후 점의 정규화된 좌표이다. 접선 왜곡의 경우에서는 $p_1, p_2$ 두 가지 다른 매개변수를 사용하여 표현한다.

```math
x_{distorted} = x + 2p_1xy + p_2(r^2 + 2x^2)
y_{distorted} = y + p_1(r^2 + 2y^2) + 2p_2xy
```

위 두 식에서 카메라 좌표계 점 $P$ 의 경우, 5개의 왜곡 계수를 통해 픽셀 평면에서 이 점의 올바른 위치를 찾을 수 있다.

1. 3D 공간 점을 정규화된 이미지 평면에 투영한다. 정규화된 좌표를 $[x, y]^T$ 로 설정한다.

2. 정규화 평면의 점에 대한 방사형 왜곡과 전단 왜곡을 계산한다.

```math
\begin{cases}
x_{distorted} = x(1 + k_1r^2 + k_2r^4 + k_3r^6) + 2p_1xy + p_2(r^2 + 2x^2) \\
y_{distorted} = y(1 + k_1r^2 + k_2r^4 + k_3r^6) + p_1(r^2 + 2y^2) + 2p_2xy
\end{cases}
```

3. 왜곡된 점은 내부 파라미터 행렬을 통해 픽셀 평면에 투영되어 이미지에서 올바른 위치를 얻는다.

```math
\begin{cases}
u = f_xx_{distorted} + c_x \\
v = f_yy_{distorted} + c_y
\end{cases}
```

실제로 왜곡을 수정할 때 파라미터를 $k_1, p_1, p_2$ 만 선택하거나 $k_1, k_2, p_1, p_2$ 를 사용하는 등 유연하게 선택 가능하다.

실제 이미지 시스템에서 연구자들은 핀홀 모델 이외에 카메라의 어파인 및 원근 모델과 같은 다른 모델들을 제안하였으며, 다른 유형의 왜곡들도 존재한다. Visual SLAM에서 일반적으로 사용되는 카메라를 고려할 때, 핀홀 모델과 방사령 및 접선 왜곡 모델로도 충분하다.